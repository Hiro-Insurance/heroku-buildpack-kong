#!/usr/bin/env bash
set -eu

export KONG_CONF="${KONG_CONF:-config/kong.conf}"

echo "Checking connection to Postgres database"
database_fails=1
while ! psql $DATABASE_URL --quiet --output /dev/null -c "SELECT 1"
do
  if [ "$database_fails" -eq "31" ]; then
    echo "$(date -u) Connection to Postgres database could not be established within 15-minutes"
    exit 2
  else
    echo "$(date -u) Attempt ${database_fails}/30: Postgres database not yet available"
    sleep 30
    database_fails=$[$database_fails +1]
  fi
done

if [ -x "bin/prerelease" ]
then
  echo "Running app's bin/prerelease"
  ./bin/prerelease
fi

echo "~~~~~~~ Debug ~~~~~~~"
echo "which resty"
which resty || echo "(none)"
echo '/usr/bin/env'
/usr/bin/env
echo '$PATH'
echo "$PATH"
echo "ls -hal /app"
ls -hal /app || echo "(none)"
echo "ls -hal /app/.heroku"
ls -hal /app/.heroku || echo "(none)"
echo "ls -hal /app/.heroku/bin"
ls -hal /app/.heroku/bin || echo "(none)"
echo "ls -hal /app/kong-runtime"
ls -hal /app/kong-runtime || echo "(none)"
echo "ls -hal /app/kong-runtime/bin"
ls -hal /app/kong-runtime/bin || echo "(none)"

kong migrations up -c $KONG_CONF $@
